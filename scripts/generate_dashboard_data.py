#!/usr/bin/env python3
"""
Generate JavaScript data file for the dashboard from benchmark results.
This script reads the CSV and JSON summary files and creates a JavaScript file
that can be included directly in the HTML dashboard.
"""

import os
import json
import csv
from pathlib import Path

def load_csv_data(csv_path):
    """Load basic data from CSV file."""
    data = []
    with open(csv_path, 'r') as f:
        reader = csv.DictReader(f)
        for row in reader:
            # Convert numeric fields
            row['vus'] = int(row['vus']) if row['vus'] else None
            row['rps'] = float(row['rps']) if row['rps'] else None
            data.append(row)
    return data

def load_summary_data(summary_path):
    """Load detailed data from JSON summary file."""
    try:
        with open(summary_path, 'r') as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        return None

def parse_detailed_data(csv_row, summary_data):
    """Parse detailed data from summary JSON."""
    if not summary_data:
        return parse_basic_data(csv_row)
    
    metrics = summary_data.get('metrics', {})
    checks = summary_data.get('root_group', {}).get('checks', {})
    
    # Calculate total passes and fails
    total_passes = 0
    total_fails = 0
    
    for check in checks.values():
        if 'passes' in check:
            total_passes += check['passes']
        if 'fails' in check:
            total_fails += check['fails']
    
    check_rate = total_passes / (total_passes + total_fails) if (total_passes + total_fails) > 0 else 0
    
    # Extract response time metrics
    http_req_duration = metrics.get('http_req_duration', {})
    response_time = None
    if http_req_duration:
        response_time = {
            'min': http_req_duration.get('min'),
            'med': http_req_duration.get('med'),
            'avg': http_req_duration.get('avg'),
            'max': http_req_duration.get('max'),
            'p95': http_req_duration.get('p(95)'),
            'p99': http_req_duration.get('p(99)')
        }
    
    return {
        'implementation': csv_row['implementation'],
        'test': csv_row['test'],
        'vus': csv_row['vus'],
        'duration': csv_row['duration'],
        'rps': csv_row['rps'] or (metrics.get('http_reqs', {}).get('rate')),
        'status': csv_row['status'],
        'responseTime': response_time,
        'totalRequests': metrics.get('http_reqs', {}).get('count', 0),
        'checks': {
            'passes': total_passes,
            'fails': total_fails,
            'rate': check_rate
        }
    }

def parse_basic_data(csv_row):
    """Parse basic data when detailed summary is not available."""
    return {
        'implementation': csv_row['implementation'],
        'test': csv_row['test'],
        'vus': csv_row['vus'],
        'duration': csv_row['duration'],
        'rps': csv_row['rps'],
        'status': csv_row['status'],
        'responseTime': None,
        'totalRequests': 0,
        'checks': {
            'passes': 0,
            'fails': 0,
            'rate': 0
        }
    }

def main():
    # Paths
    script_dir = Path(__file__).parent
    project_root = script_dir.parent
    results_dir = project_root / 'benchmark_results'
    csv_path = results_dir / 'benchmark_results.csv'
    output_path = project_root / 'benchmark_data.js'
    
    print(f"Loading CSV data from: {csv_path}")
    
    # Load CSV data
    csv_data = load_csv_data(csv_path)
    
    # Process each row and load detailed data
    benchmark_data = []
    for row in csv_data:
        summary_path = results_dir / f"{row['implementation']}_{row['test']}_summary.txt"
        print(f"Processing: {row['implementation']}_{row['test']}")
        
        summary_data = load_summary_data(summary_path)
        detailed_data = parse_detailed_data(row, summary_data)
        benchmark_data.append(detailed_data)
    
    # Generate JavaScript file
    js_content = f"""// Auto-generated benchmark data
// Generated from benchmark results on {os.path.basename(__file__)}
// Do not edit this file manually - regenerate using scripts/generate_dashboard_data.py

window.benchmarkData = {json.dumps(benchmark_data, indent=2)};
"""
    
    # Write JavaScript file
    with open(output_path, 'w') as f:
        f.write(js_content)
    
    print(f"Generated benchmark data file: {output_path}")
    print(f"Processed {len(benchmark_data)} benchmark results")

if __name__ == '__main__':
    main()
